#!/usr/bin/env bash
set -euo pipefail

is_wsl() {
  # Fast positive checks for WSL1 & WSL2
  if grep -qiE 'microsoft' /proc/sys/kernel/osrelease 2>/dev/null; then
    return 0
  fi
  if grep -qiE 'microsoft' /proc/version 2>/dev/null; then
    return 0
  fi
  # Environment variables exported by WSL runtime
  if [[ -n "${WSL_INTEROP:-}" ]] || [[ -n "${WSL_DISTRO_NAME:-}" ]]; then
    return 0
  fi
  return 1
}

if ! is_wsl; then
  echo "[wslu] Not WSL; skipping."
  exit 0
fi

# Require apt-based distro
if ! command -v apt-get >/dev/null 2>&1; then
  echo "[wslu] apt-get not found; skipping (non-Debian/Ubuntu)."
  exit 0
fi

# Skip if already installed
if dpkg -s wslu >/dev/null 2>&1; then
  echo "[wslu] wslu already installed."
  exit 0
fi

echo "[wslu] Installing wslu (Windows integration helpers for WSL)..."
sudo DEBIAN_FRONTEND=noninteractive apt-get update
sudo DEBIAN_FRONTEND=noninteractive apt-get install -y wslu
echo "[wslu] Done."
